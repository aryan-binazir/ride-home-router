{{define "route_results"}}
{{if .Routes}}
<div class="routes-container"
     data-activity-location-name="{{.ActivityLocation.Name}}"
     data-activity-location-address="{{.ActivityLocation.Address}}"
     data-session-id="{{.SessionID}}"
     data-route-count="{{len .Routes}}">
    <div class="routes-header">
        <div>
            <h3 class="routes-title">Calculated Routes</h3>
            <p class="routes-subtitle text-muted">Copy routes, make quick tweaks, then save the event.</p>
        </div>
        <div class="routes-actions">
            {{if .IsEditing}}
            <button type="button" class="btn btn-warning btn-sm" onclick="resetRoutes()">
                Reset to Original
            </button>
            {{end}}
            <button type="button" class="btn btn-secondary" onclick="copyAllRoutes()" id="copy-all-btn">
                Copy All Routes
            </button>
        </div>
    </div>

    {{$useMiles := .UseMiles}}
    {{$activityLocation := .ActivityLocation}}
    {{$sessionID := .SessionID}}
    {{$routeCount := len .Routes}}
    {{range $routeIndex, $route := .Routes}}
    <div class="route-card {{if .OrgVehicleID}}org-vehicle{{end}}"
         data-activity-location-address="{{$activityLocation.Address}}"
         data-driver-name="{{.Driver.Name}}"
         data-route-index="{{$routeIndex}}"
         data-driver-id="{{.Driver.ID}}">
        <div class="route-header">
            <div class="driver-info">
                <div class="driver-avatar" aria-hidden="true">{{initials .Driver.Name}}</div>
                <div class="driver-meta">
                    <h3>
                        {{.Driver.Name}}
                        {{if .OrgVehicleID}}
                        <span class="badge badge-info">{{.OrgVehicleName}}</span>
                        {{end}}
                    </h3>
                    <p>{{.Driver.Address}}</p>
                </div>
            </div>
            <div class="route-stats">
                <div class="stat">
                    <strong>Capacity:</strong> {{.EffectiveCapacity}} passengers
                </div>
                <div class="stat">
                    <strong>Passengers:</strong> {{len .Stops}}
                </div>
                <div class="stat">
                    <strong>Dropoff Distance:</strong> {{formatDistance .TotalDropoffDistanceMeters $useMiles}}
                </div>
                <div class="stat">
                    <strong>To Home:</strong>
                    {{formatDistance .DistanceToDriverHomeMeters $useMiles}}
                </div>
                <div class="stat">
                    <strong>Total:</strong> {{formatDistance .TotalDistanceMeters $useMiles}}
                </div>
                <div class="stat">
                    <strong>Detour:</strong> {{formatDuration .DetourSecs}}
                </div>
            </div>
        </div>

        <!-- Driver Swap Controls -->
        {{if gt $routeCount 1}}
        <div class="route-tools">
            <select class="form-select form-input-sm form-input-inline" id="swap-select-{{$routeIndex}}">
                <option value="">Swap driver with...</option>
                {{range $i, $r := $.Routes}}
                {{if ne $i $routeIndex}}
                <option value="{{$i}}">{{$r.Driver.Name}}</option>
                {{end}}
                {{end}}
            </select>
            <button type="button" class="btn btn-sm btn-outline" onclick="swapDrivers({{$routeIndex}})">
                Swap
            </button>
        </div>
        {{end}}

        <div class="route-stops">
            {{if .Stops}}
            <div class="d-flex justify-between align-center mb-2">
                <h4>Route:</h4>
                <button type="button" class="btn btn-sm btn-outline" onclick="copyRoute(this)">
                    Copy Route
                </button>
            </div>
            {{range .Stops}}
            <div class="stop-item"
                 data-participant-name="{{.Participant.Name}}"
                 data-participant-address="{{.Participant.Address}}"
                 data-participant-id="{{.Participant.ID}}">
                <div class="stop-number">{{add .Order 1}}</div>
                <div class="stop-details">
                    <h4>{{.Participant.Name}}</h4>
                    <p>{{.Participant.Address}}</p>
                </div>
                <div class="stop-distance">
                    {{if eq .Order 0}}
                        {{formatDistance .DistanceFromPrevMeters $useMiles}} from {{$activityLocation.Name}}
                    {{else}}
                        {{formatDistance .DistanceFromPrevMeters $useMiles}}
                    {{end}}
                </div>
                {{if gt $routeCount 1}}
                <div class="stop-actions">
                    <select class="form-select form-input-sm form-input-inline"
                            onchange="moveParticipant({{.Participant.ID}}, {{$routeIndex}}, this.value); this.value='';">
                        <option value="">Move to...</option>
                        {{range $i, $r := $.Routes}}
                        {{if ne $i $routeIndex}}
                        <option value="{{$i}}">{{$r.Driver.Name}}</option>
                        {{end}}
                        {{end}}
                    </select>
                </div>
                {{end}}
            </div>
            {{end}}
            {{else}}
            <div class="empty-route-message">
                <p class="text-muted">No passengers assigned. Use "Move to..." on other routes to add passengers.</p>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Unused Drivers Section -->
    {{if .UnusedDrivers}}
    <details class="unused-drivers-section mt-3">
        <summary class="unused-drivers-header">
            <svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>Unused Drivers ({{len .UnusedDrivers}}) - click to expand</span>
        </summary>
        <div class="unused-drivers-list">
            {{range .UnusedDrivers}}
            <div class="unused-driver-item">
                <div class="driver-info-compact">
                    <span class="driver-name">{{.Name}}</span>
                    <span class="driver-capacity text-muted">Capacity: {{.VehicleCapacity}}</span>
                </div>
                <button type="button" class="btn btn-sm btn-primary"
                        onclick="addUnusedDriver({{.ID}})">
                    + Add to Routes
                </button>
            </div>
            {{end}}
        </div>
    </details>
    {{end}}

    <!-- Summary -->
    <div class="route-summary">
        <h3>Summary</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="label">Total Participants</div>
                <div class="value">{{.Summary.TotalParticipants}}</div>
            </div>
            <div class="summary-item">
                <div class="label">Drivers Used</div>
                <div class="value">{{.Summary.TotalDriversUsed}}</div>
            </div>
            <div class="summary-item">
                <div class="label">Total Distance</div>
                <div class="value">{{formatDistance .Summary.TotalDistanceMeters .UseMiles}}</div>
            </div>
            {{if gt .Summary.OrgVehiclesUsed 0}}
            <div class="summary-item">
                <div class="label">Org Vehicles</div>
                <div class="value text-info">{{.Summary.OrgVehiclesUsed}} used</div>
            </div>
            {{end}}
            {{if gt .Summary.MaxDetourSecs 0.0}}
            <div class="summary-item">
                <div class="label">Max Detour</div>
                <div class="value">{{formatDuration .Summary.MaxDetourSecs}}</div>
            </div>
            <div class="summary-item">
                <div class="label">Average Detour</div>
                <div class="value">{{formatDuration .Summary.AverageDetourSecs}}</div>
            </div>
            {{end}}
        </div>

        {{if .Warnings}}
        <div class="alert alert-warning mt-3">
            <strong>Warnings:</strong>
            <ul>
                {{range .Warnings}}
                <li>{{.}}</li>
                {{end}}
            </ul>
        </div>
        {{end}}
    </div>

    <!-- Save Event Form -->
    <div class="card mt-4">
        <h3>Save This Event</h3>
        <form hx-post="/api/v1/events"
              hx-target="#save-result"
              hx-indicator="#save-loading">
            <input type="hidden" name="routes_json" value="{{toJSON .}}">

            <div class="form-group">
                <label class="form-label">Event Date</label>
                <input type="date"
                       name="event_date"
                       class="form-input"
                       value="{{currentDate}}"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes"
                          class="form-textarea"
                          placeholder="Any additional notes about this event..."></textarea>
            </div>

            <div class="d-flex align-center gap-2">
                <button type="submit" class="btn btn-success">
                    Save Event to History
                </button>
                <span class="loading htmx-indicator" id="save-loading"></span>
            </div>

            <div id="save-result" class="mt-3"></div>
        </form>
    </div>
</div>
{{else}}
{{if .Error}}
<div class="error-message">
    <strong>Error:</strong> {{.Error.Message}}
    {{if .Error.Details}}
    <div class="mt-2">
        <small>
            Unassigned: {{.Error.Details.UnassignedCount}} participants,
            Total Capacity: {{.Error.Details.TotalCapacity}},
            Total Participants: {{.Error.Details.TotalParticipants}}
        </small>
    </div>
    {{end}}
</div>
{{end}}
{{end}}
{{end}}
