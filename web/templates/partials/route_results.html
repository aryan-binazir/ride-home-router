{{define "route_results"}}
{{if .Routes}}
<div class="routes-container">
    <h3>Calculated Routes</h3>

    {{range .Routes}}
    <div class="route-card {{if .UsedInstituteVehicle}}institute-vehicle{{end}}">
        <div class="route-header">
            <div class="driver-info">
                <h3>
                    {{.Driver.Name}}
                    {{if .UsedInstituteVehicle}}
                    <span class="text-warning">(Institute Vehicle)</span>
                    {{end}}
                </h3>
                <p>{{.Driver.Address}}</p>
            </div>
            <div class="route-stats">
                <div class="stat">
                    <strong>Capacity:</strong> {{.Driver.VehicleCapacity}} passengers
                </div>
                <div class="stat">
                    <strong>Passengers:</strong> {{len .Stops}}
                </div>
                <div class="stat">
                    <strong>Dropoff Distance:</strong> {{printf "%.2f" (divideFloat .TotalDropoffDistanceMeters 1000)}} km
                </div>
                {{if not .UsedInstituteVehicle}}
                <div class="stat">
                    <strong>To Home:</strong> {{printf "%.2f" (divideFloat .DistanceToDriverHomeMeters 1000)}} km
                </div>
                {{end}}
            </div>
        </div>

        <div class="route-stops">
            <h4>Route:</h4>
            {{range .Stops}}
            <div class="stop-item">
                <div class="stop-number">{{add .Order 1}}</div>
                <div class="stop-details">
                    <h4>{{.Participant.Name}}</h4>
                    <p>{{.Participant.Address}}</p>
                </div>
                <div class="stop-distance">
                    {{if eq .Order 0}}
                        {{printf "%.2f km from institute" (divideFloat .DistanceFromPrevMeters 1000)}}
                    {{else}}
                        {{printf "%.2f km" (divideFloat .DistanceFromPrevMeters 1000)}}
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Summary -->
    <div class="route-summary">
        <h3>Summary</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="label">Total Participants</div>
                <div class="value">{{.Summary.TotalParticipants}}</div>
            </div>
            <div class="summary-item">
                <div class="label">Drivers Used</div>
                <div class="value">{{.Summary.TotalDriversUsed}}</div>
            </div>
            <div class="summary-item">
                <div class="label">Total Distance</div>
                <div class="value">{{printf "%.1f km" (divideFloat .Summary.TotalDropoffDistanceMeters 1000)}}</div>
            </div>
            {{if .Summary.UsedInstituteVehicle}}
            <div class="summary-item">
                <div class="label">Institute Vehicle</div>
                <div class="value text-warning">Used</div>
            </div>
            {{end}}
        </div>

        {{if .Warnings}}
        <div class="alert alert-warning mt-3">
            <strong>Warnings:</strong>
            <ul>
                {{range .Warnings}}
                <li>{{.}}</li>
                {{end}}
            </ul>
        </div>
        {{end}}
    </div>

    <!-- Save Event Form -->
    <div class="card mt-4">
        <h3>Save This Event</h3>
        <form hx-post="/api/v1/events"
              hx-ext="json-enc"
              hx-target="#save-result"
              hx-indicator="#save-loading">
            <input type="hidden" name="routes_json" value="{{toJSON .}}">

            <div class="form-group">
                <label class="form-label">Event Date</label>
                <input type="date"
                       name="event_date"
                       class="form-input"
                       value="{{currentDate}}"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes"
                          class="form-textarea"
                          placeholder="Any additional notes about this event..."></textarea>
            </div>

            <div class="d-flex align-center gap-2">
                <button type="submit" class="btn btn-success">
                    Save Event to History
                </button>
                <span class="loading htmx-indicator" id="save-loading"></span>
            </div>

            <div id="save-result" class="mt-3"></div>
        </form>
    </div>
</div>
{{else}}
{{if .Error}}
<div class="error-message">
    <strong>Error:</strong> {{.Error.Message}}
    {{if .Error.Details}}
    <div class="mt-2">
        <small>
            Unassigned: {{.Error.Details.UnassignedCount}} participants,
            Total Capacity: {{.Error.Details.TotalCapacity}},
            Total Participants: {{.Error.Details.TotalParticipants}}
        </small>
    </div>
    {{end}}
</div>
{{end}}
{{end}}
{{end}}
