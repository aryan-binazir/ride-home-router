{{define "content"}}
<div class="page-header">
    <div>
        <h2 class="page-title">Settings</h2>
        <p class="page-subtitle">Manage activity locations and choose how distances are displayed.</p>
    </div>
</div>

<!-- Activity Locations Management -->
<div class="card">
    <h3>Activity Locations</h3>
    <p class="text-muted">Manage locations where activities take place (e.g., Soccer Practice, School).</p>

    <!-- Add New Location Form -->
    <form hx-post="/api/v1/activity-locations"
          hx-target="#location-list"
          hx-swap="beforeend"
          hx-on::after-request="if(event.detail.requestConfig.verb === 'post') this.reset()"
          class="mb-4">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Location Name</label>
                <input type="text"
                       name="name"
                       class="form-input"
                       placeholder="e.g., Soccer Practice"
                       required>
            </div>
            <div class="form-group form-group-wide">
                <label class="form-label">Address</label>
                {{template "address_input" ""}}
            </div>
            <div class="form-group form-group-actions">
                <button type="submit" class="btn btn-primary">Add Location</button>
            </div>
        </div>
    </form>

    <!-- Existing Locations List -->
    <div id="location-list">
        {{if .ActivityLocations}}
        {{range .ActivityLocations}}
        <div class="list-card" id="activity-location-{{.ID}}">
            <div class="d-flex justify-between align-center gap-2">
                <div>
                    <div class="d-flex align-center gap-2">
                        <strong>{{.Name}}</strong>
                    </div>
                    <p class="text-muted mb-0">{{.Address}}</p>
                    <p class="text-muted mb-0" style="font-size: 0.75rem;">
                        Coordinates: {{printf "%.6f" .Lat}}, {{printf "%.6f" .Lng}}
                    </p>
                </div>
                <button hx-delete="/api/v1/activity-locations/{{.ID}}"
                        hx-confirm="Are you sure you want to delete this location?"
                        hx-target="#activity-location-{{.ID}}"
                        hx-swap="outerHTML swap:1s"
                        class="btn btn-danger btn-sm">
                    Delete
                </button>
            </div>
        </div>
        {{end}}
        {{else}}
        <p class="text-muted" id="no-locations-message">No activity locations yet. Add one above.</p>
        {{end}}
    </div>
</div>

<!-- Organization Vehicles Management -->
<div class="card">
    <h3>Organization Vehicles</h3>
    <p class="text-muted">Vehicles owned by the organization that can be assigned to drivers during events.</p>

    <!-- Add New Vehicle Form -->
    <form hx-post="/api/v1/org-vehicles"
          hx-target="#org-vehicle-list"
          hx-swap="beforeend"
          hx-on::after-request="if(event.detail.requestConfig.verb === 'post') this.reset()"
          class="mb-4">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Vehicle Name</label>
                <input type="text"
                       name="name"
                       class="form-input"
                       placeholder="e.g., School Van"
                       required>
            </div>
            <div class="form-group">
                <label class="form-label">Capacity</label>
                <input type="number"
                       name="capacity"
                       class="form-input"
                       placeholder="Seats"
                       min="1"
                       required>
            </div>
            <div class="form-group form-group-actions">
                <button type="submit" class="btn btn-primary">Add Vehicle</button>
            </div>
        </div>
    </form>

    <!-- Existing Vehicles List -->
    <div id="org-vehicle-list">
        {{if .OrgVehicles}}
        {{range .OrgVehicles}}
        <div class="list-card" id="org-vehicle-{{.ID}}">
            <div class="d-flex justify-between align-center gap-2">
                <div>
                    <div class="d-flex align-center gap-2">
                        <strong>{{.Name}}</strong>
                        <span class="badge badge-muted">{{.Capacity}} seats</span>
                    </div>
                </div>
                <button hx-delete="/api/v1/org-vehicles/{{.ID}}"
                        hx-confirm="Are you sure you want to delete this vehicle?"
                        hx-target="#org-vehicle-{{.ID}}"
                        hx-swap="outerHTML swap:1s"
                        class="btn btn-danger btn-sm">
                    Delete
                </button>
            </div>
        </div>
        {{end}}
        {{else}}
        <p class="text-muted" id="no-vehicles-message">No organization vehicles yet. Add one above.</p>
        {{end}}
    </div>
</div>

<!-- Settings Form -->
<div class="card">
    <h3>Active Location &amp; Preferences</h3>
    <p class="text-muted">Select the activity location to use for route calculations.</p>

    <form id="settings-form"
          hx-put="/api/v1/settings"
          hx-swap="none"
          hx-indicator="#settings-loading">
        <div class="form-group">
            <label class="form-label">Selected Activity Location</label>
            <div class="ui-select" id="activity-location-select">
                <select name="selected_activity_location_id" class="form-select ui-select-native" required>
                    <option value="">-- Select a location --</option>
                    {{range .ActivityLocations}}
                    <option value="{{.ID}}" {{if eq $.Settings.SelectedActivityLocationID .ID}}selected{{end}}>
                        {{.Name}} ({{.Address}})
                    </option>
                    {{end}}
                </select>

                <button type="button"
                        class="ui-select-trigger"
                        aria-haspopup="listbox"
                        aria-expanded="false"
                        aria-label="Selected activity location">
                    <span class="ui-select-trigger-text">
                        {{if .SelectedLocation}}
                        <span class="ui-select-trigger-title">{{.SelectedLocation.Name}}</span>
                        <span class="ui-select-trigger-subtitle">{{.SelectedLocation.Address}}</span>
                        {{else}}
                        <span class="ui-select-trigger-title">-- Select a location --</span>
                        <span class="ui-select-trigger-subtitle hidden"></span>
                        {{end}}
                    </span>
                    <span class="ui-select-chevron" aria-hidden="true"></span>
                </button>

                <div class="ui-select-menu" role="listbox" tabindex="-1">
                    <button type="button"
                            class="ui-select-option {{if eq $.Settings.SelectedActivityLocationID 0}}is-selected{{end}}"
                            role="option"
                            aria-selected="{{if eq $.Settings.SelectedActivityLocationID 0}}true{{else}}false{{end}}"
                            data-value=""
                            data-title="-- Select a location --"
                            data-subtitle="">
                        <span class="ui-select-option-title">-- Select a location --</span>
                    </button>
                    {{range .ActivityLocations}}
                    <button type="button"
                            class="ui-select-option {{if eq $.Settings.SelectedActivityLocationID .ID}}is-selected{{end}}"
                            role="option"
                            aria-selected="{{if eq $.Settings.SelectedActivityLocationID .ID}}true{{else}}false{{end}}"
                            data-value="{{.ID}}"
                            data-title="{{.Name}}"
                            data-subtitle="{{.Address}}">
                        <span class="ui-select-option-title">{{.Name}}</span>
                        <span class="ui-select-option-subtitle">{{.Address}}</span>
                    </button>
                    {{end}}
                </div>
            </div>
            {{if .SelectedLocation}}
            <div class="form-help">
                Current: {{.SelectedLocation.Name}} at {{printf "%.6f" .SelectedLocation.Lat}}, {{printf "%.6f" .SelectedLocation.Lng}}
            </div>
            {{end}}
        </div>

        <div class="form-group">
            <label class="form-label">Distance Units</label>
            <div class="d-flex align-center gap-2">
                <label class="checkbox-label">
                    <input type="checkbox"
                           name="use_miles"
                           class="form-checkbox"
                           {{if .Settings.UseMiles}}checked{{end}}>
                    <span>Use miles instead of kilometers</span>
                </label>
            </div>
        </div>

        <div class="d-flex align-center gap-2">
            <button type="submit" class="btn btn-primary">
                Save Settings
            </button>
            <span class="loading htmx-indicator" id="settings-loading"></span>
        </div>
    </form>
</div>
{{end}}
